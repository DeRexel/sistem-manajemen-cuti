{% extends "layouts/dashboard.twig" %}

{% block title %}Pengaturan Akun - SICUTI{% endblock %}

{% block page_title %}Pengaturan Akun{% endblock %}

{% block dashboard_content %}
<div class="space-y-6">
    <!-- Profile Information -->
    <div class="card">
        <div class="card-header">
            <h3 class="text-lg font-medium text-gray-900">Informasi Profil</h3>
        </div>
        <div class="card-body">
            {% if employee %}
            <form id="profileForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nama</label>
                        <input type="text" value="{{ employee.nama }}" class="form-input mt-1" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">NIP</label>
                        <input type="text" value="{{ employee.nip }}" class="form-input mt-1" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Jabatan</label>
                        <input type="text" value="{{ employee.jabatan }}" class="form-input mt-1" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Unit Kerja</label>
                        <input type="text" value="{{ employee.unit_kerja }}" class="form-input mt-1" readonly>
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="email" name="email" value="{{ employee.email }}" class="form-input mt-1">
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700">Telepon</label>
                        <input type="text" id="phone" name="phone" value="{{ employee.phone }}" class="form-input mt-1">
                    </div>
                </div>
                <div>
                    <label for="alamat" class="block text-sm font-medium text-gray-700">Alamat</label>
                    <textarea id="alamat" name="alamat" rows="3" class="form-input mt-1">{{ employee.alamat }}</textarea>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="btn-primary">Simpan Perubahan</button>
                </div>
            </form>
            {% endif %}
        </div>
    </div>

    <!-- Change Password -->
    <div class="card">
        <div class="card-header">
            <h3 class="text-lg font-medium text-gray-900">Ubah Password</h3>
        </div>
        <div class="card-body">
            <form id="passwordForm" class="space-y-4">
                <div>
                    <label for="current_password" class="block text-sm font-medium text-gray-700">Password Lama</label>
                    <input type="password" id="current_password" name="current_password" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="new_password" class="block text-sm font-medium text-gray-700">Password Baru</label>
                    <input type="password" id="new_password" name="new_password" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="confirm_password" class="block text-sm font-medium text-gray-700">Konfirmasi Password Baru</label>
                    <input type="password" id="confirm_password" name="confirm_password" class="form-input mt-1" required>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="btn-primary">Ubah Password</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Digital Signature Settings -->
    {% if employee %}
    <div class="card">
        <div class="card-header">
            <h3 class="text-lg font-medium text-gray-900">Pengaturan Tanda Tangan Digital</h3>
        </div>
        <div class="card-body">
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="text-sm font-medium text-gray-900">Status Tanda Tangan Digital</h4>
                        <p class="text-sm text-gray-500">
                            {% if employee.digital_signature_path %}
                                Tanda tangan digital sudah diupload
                            {% else %}
                                Belum ada tanda tangan digital
                            {% endif %}
                        </p>
                    </div>
                    <div class="flex space-x-2">
                        <input type="file" id="signatureUpload" accept="image/*" style="display: none;" onchange="uploadSignature()">
                        <button onclick="document.getElementById('signatureUpload').click()" class="btn-secondary">
                            <i class="fas fa-upload mr-2"></i>
                            {{ employee.digital_signature_path ? 'Ganti' : 'Upload' }} TTD
                        </button>
                    </div>
                </div>
                
                {% if employee.digital_signature_path %}
                <div class="mt-4">
                    <img src="/uploads/employee_signatures/{{ employee.digital_signature_path }}" 
                         alt="Tanda Tangan" class="border rounded p-2" style="max-width: 200px;">
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Profile Form
document.getElementById('profileForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    fetch('/account/profile', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Profil berhasil diperbarui');
        } else {
            alert('Error: ' + data.message);
        }
    });
});

// Password Form
document.getElementById('passwordForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    fetch('/account/password', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Password berhasil diubah');
            this.reset();
        } else {
            alert('Error: ' + data.message);
        }
    });
});

// Upload Signature
function uploadSignature() {
    const fileInput = document.getElementById('signatureUpload');
    const file = fileInput.files[0];
    
    if (!file) return;
    
    const formData = new FormData();
    formData.append('signature', file);
    
    fetch('/user/signature/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Tanda tangan berhasil diupload');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}
</script>
{% endblock %}