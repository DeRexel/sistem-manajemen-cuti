{% extends "layouts/dashboard.twig" %}

{% block title %}Ajukan Cuti - SICUTI{% endblock %}

{% block page_title %}Ajukan Cuti Baru{% endblock %}

{% block dashboard_content %}
<div class="max-w-4xl mx-auto">
    {% if error_message %}
    <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-triangle text-red-400"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">Error Validasi</h3>
                <div class="mt-2 text-sm text-red-700">
                    {{ error_message|raw }}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="card p-6">
        <form method="POST" action="/user/cuti/create" class="space-y-6">
            <!-- Employee Info -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Data Pegawai</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nama</label>
                        <p class="mt-1 text-sm text-gray-900">{{ employee.nama }}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">NIP</label>
                        <p class="mt-1 text-sm text-gray-900">{{ employee.nip }}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Jabatan</label>
                        <p class="mt-1 text-sm text-gray-900">{{ employee.jabatan }}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Unit Kerja</label>
                        <p class="mt-1 text-sm text-gray-900">{{ employee.unit_kerja }}</p>
                    </div>
                </div>
            </div>

            <!-- Leave Type -->
            <div>
                <label for="jenis_cuti" class="block text-sm font-medium text-gray-700">Jenis Cuti</label>
                <select id="jenis_cuti" name="jenis_cuti" required class="form-input mt-1">
                    <option value="">Pilih Jenis Cuti</option>
                    <option value="tahunan">Cuti Tahunan (CT)</option>
                    <option value="besar">Cuti Besar (CB)</option>
                    <option value="sakit">Cuti Sakit (CS)</option>
                    <option value="melahirkan">Cuti Melahirkan (CM)</option>
                    <option value="alasan_penting">Cuti Karena Alasan Penting (CAP)</option>
                    <option value="diluar_tanggungan">Cuti Diluar Tanggungan Negara (CLTN)</option>
                </select>
                <div id="cutiInfo" class="mt-2 text-sm text-gray-600 hidden"></div>
            </div>

            <!-- Reason -->
            <div>
                <label for="alasan" class="block text-sm font-medium text-gray-700">Alasan Cuti</label>
                <textarea id="alasan" name="alasan" rows="3" required class="form-input mt-1" placeholder="Jelaskan alasan pengajuan cuti..."></textarea>
            </div>

            <!-- Date Range -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="tanggal_mulai" class="block text-sm font-medium text-gray-700">Tanggal Mulai</label>
                    <input type="date" id="tanggal_mulai" name="tanggal_mulai" required class="form-input mt-1">
                </div>
                <div>
                    <label for="tanggal_selesai" class="block text-sm font-medium text-gray-700">Tanggal Selesai</label>
                    <input type="date" id="tanggal_selesai" name="tanggal_selesai" required class="form-input mt-1">
                </div>
                <div>
                    <label for="lama_hari" class="block text-sm font-medium text-gray-700">Lama Hari</label>
                    <input type="number" id="lama_hari" name="lama_hari" readonly class="form-input mt-1 bg-gray-50">
                </div>
            </div>

            <!-- Contact Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Alamat Selama Cuti</label>
                    <div class="space-y-2">
                        <div>
                            <label for="alamat_jalan" class="block text-xs text-gray-600">Alamat</label>
                            <input type="text" id="alamat_jalan" class="form-input" placeholder="Jalan, RT/RW, No. Rumah">
                        </div>
                        <div>
                            <label for="alamat_kelurahan" class="block text-xs text-gray-600">Kelurahan/Desa</label>
                            <input type="text" id="alamat_kelurahan" class="form-input" placeholder="Nama kelurahan/desa">
                        </div>
                        <div>
                            <label for="alamat_kabkota" class="block text-xs text-gray-600">Kab/Kota</label>
                            <input type="text" id="alamat_kabkota" class="form-input" placeholder="Kabupaten/Kota">
                        </div>
                    </div>
                    <input type="hidden" id="alamat_cuti" name="alamat_cuti" required>
                </div>
                <div>
                    <label for="telp_cuti" class="block text-sm font-medium text-gray-700">Telepon</label>
                    <input type="tel" id="telp_cuti" name="telp_cuti" class="form-input mt-1" placeholder="Nomor telepon yang bisa dihubungi">
                </div>
            </div>

            <!-- Pejabat -->
            <div>
                <label for="pejabat_id" class="block text-sm font-medium text-gray-700">Pejabat Berwenang</label>
                <select id="pejabat_id" name="pejabat_id" required class="form-input mt-1">
                    <option value="">Pilih Pejabat</option>
                    {% for pejabat in pejabat_list %}
                    <option value="{{ pejabat.id }}">{{ pejabat.nama }} - {{ pejabat.jabatan }}</option>
                    {% endfor %}
                </select>
            </div>

<<<<<<< HEAD
            <!-- Signature Method -->
            <div class="bg-yellow-50 p-4 rounded-lg">
                <h4 class="text-sm font-medium text-yellow-900 mb-3">Metode Tanda Tangan</h4>
                <div class="space-y-3">
                    {% if employee.use_digital_signature is defined and employee.digital_signature_path is defined and employee.use_digital_signature and employee.digital_signature_path %}
                    <!-- User sudah punya TTD Digital -->
                    <label class="flex items-center">
                        <input type="radio" name="signature_method" value="digital" class="mr-2" checked>
                        <span class="text-sm text-green-700"><i class="fas fa-check-circle mr-1"></i>Gunakan Tanda Tangan Digital (Otomatis submit)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="signature_method" value="manual" class="mr-2">
                        <span class="text-sm">Tanda Tangan Manual (Download → Cetak → TTD → Upload)</span>
                    </label>
                    <div class="mt-2 p-3 bg-green-50 rounded">
                        <p class="text-sm text-green-700"><i class="fas fa-signature mr-1"></i>Tanda tangan digital tersedia. <a href="#" onclick="showSignatureUpload()" class="underline">Ganti tanda tangan</a> jika diperlukan.</p>
                    </div>
                    {% else %}
                    <!-- User belum punya TTD Digital -->
                    <label class="flex items-center">
                        <input type="radio" name="signature_method" value="manual" class="mr-2" checked>
                        <span class="text-sm">Tanda Tangan Manual (DDownload → Cetak → TTD → Upload)</span>
                    </label>
                    <div class="mt-2 p-3 bg-blue-50 rounded">
                        <p class="text-sm text-blue-700">Belum ada tanda tangan digital. <a href="#" onclick="showSignatureUpload()" class="underline">Upload tanda tangan digital</a> untuk kemudahan di masa depan.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Digital Signature Upload (Hidden by default) -->
            <div id="signatureUpload" class="hidden bg-gray-50 p-4 rounded-lg">
                <h4 class="text-sm font-medium text-gray-900 mb-3">
                    {% if employee.digital_signature_path is defined and employee.digital_signature_path %}
                        Ganti Tanda Tangan Digital
                    {% else %}
                        Upload Tanda Tangan Digital
                    {% endif %}
                </h4>
                <div class="space-y-3">
                    <p class="text-xs text-gray-600">Format: PNG/JPG, akan otomatis diresize ke 160x80px</p>
                    {% if employee.digital_signature_path is defined and employee.digital_signature_path %}
                    <div class="p-2 bg-yellow-50 rounded text-xs text-yellow-700">
                        <i class="fas fa-info-circle mr-1"></i>Anda sudah memiliki tanda tangan digital. Upload file baru akan mengganti yang lama.
                    </div>
                    {% endif %}
                    <input type="file" id="signatureFile" accept="image/png,image/jpeg,image/jpg" class="form-input">
                    <div id="uploadError" class="hidden p-2 bg-red-50 text-red-700 text-sm rounded"></div>
                    <div id="uploadSuccess" class="hidden p-2 bg-green-50 text-green-700 text-sm rounded"></div>
                    <div class="flex space-x-2">
                        <button type="button" onclick="uploadSignature()" class="btn-secondary text-sm" id="uploadBtn">
                            {% if employee.digital_signature_path is defined and employee.digital_signature_path %}
                                Ganti
                            {% else %}
                                Upload
                            {% endif %}
                        </button>
                        <button type="button" onclick="hideSignatureUpload()" class="px-3 py-1 text-sm border rounded">Batal</button>
                    </div>
                </div>
            </div>

            <!-- Required Documents Alert -->
            <div id="requiredDocsAlert" class="hidden bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                <h4 class="text-sm font-medium text-yellow-900 mb-2">
                    <i class="fas fa-file-alt mr-1"></i>Berkas Tambahan Diperlukan
                </h4>
                <div id="requiredDocsList" class="text-sm text-yellow-800"></div>
                <p class="text-xs text-yellow-700 mt-2">Berkas ini akan diminta setelah formulir dibuat</p>
            </div>

=======
>>>>>>> parent of 53b33dd (Basic Function)
            <!-- Quota Info -->
            <div class="bg-blue-50 p-4 rounded-lg">
                <h4 class="text-sm font-medium text-blue-900 mb-2">Informasi Kuota Cuti</h4>
                <div class="grid grid-cols-3 gap-4 text-sm">
                    <div>
                        <span class="text-blue-700">Sisa Cuti N-2:</span>
                        <span class="font-medium">{{ employee.sisa_cuti_n2 }} hari</span>
                    </div>
                    <div>
                        <span class="text-blue-700">Sisa Cuti N-1:</span>
                        <span class="font-medium">{{ employee.sisa_cuti_n1 }} hari</span>
                    </div>
                    <div>
                        <span class="text-blue-700">Sisa Cuti Tahun Ini:</span>
                        <span class="font-medium">{{ employee.sisa_cuti_n }} hari</span>
                    </div>
                </div>
                <div class="mt-2 text-xs text-blue-600">
                    <strong>Total tersedia:</strong> {{ employee.sisa_cuti_n2 + employee.sisa_cuti_n1 + employee.sisa_cuti_n }} hari
                    <br><em>Penggunaan: N-2 → N-1 → Tahun ini</em>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="flex justify-end space-x-4">
                <a href="/user/dashboard" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                    Batal
                </a>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-save mr-2"></i>
                    Buat Pengajuan
                </button>
            </div>
        </form>
    </div>
</div>
<<<<<<< HEAD

<script>
function showSignatureUpload() {
    document.getElementById('signatureUpload').classList.remove('hidden');
}

function hideSignatureUpload() {
    document.getElementById('signatureUpload').classList.add('hidden');
}

function uploadSignature() {
    const fileInput = document.getElementById('signatureFile');
    const errorDiv = document.getElementById('uploadError');
    const successDiv = document.getElementById('uploadSuccess');
    
    // Hide previous messages
    errorDiv.classList.add('hidden');
    successDiv.classList.add('hidden');
    
    if (!fileInput.files[0]) {
        showError('Pilih file tanda tangan terlebih dahulu');
        return;
    }
    
    const file = fileInput.files[0];
    if (!file.type.match(/image\/(png|jpeg|jpg)/)) {
        showError('Format file harus PNG atau JPG');
        return;
    }
    
    if (file.size > 2 * 1024 * 1024) {
        showError('Ukuran file maksimal 2MB');
        return;
    }
    
    const formData = new FormData();
    formData.append('signature', file);
    
    // Show loading
    const uploadBtn = document.getElementById('uploadBtn');
    const originalText = uploadBtn.textContent;
    uploadBtn.textContent = 'Uploading...';
    uploadBtn.disabled = true;
    
    fetch('/user/cuti/upload-signature', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Tanda tangan berhasil diupload dan diresize ke 160x80px!');
            // Auto-enable digital signature option and reload after 2 seconds
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showError(data.error || 'Gagal upload tanda tangan. Silakan coba lagi.');
        }
    })
    .catch(error => {
        showError('Error: ' + error.message);
    })
    .finally(() => {
        uploadBtn.textContent = originalText;
        uploadBtn.disabled = false;
    });
}

function showError(message) {
    const errorDiv = document.getElementById('uploadError');
    errorDiv.textContent = message;
    errorDiv.classList.remove('hidden');
}

function showSuccess(message) {
    const successDiv = document.getElementById('uploadSuccess');
    successDiv.textContent = message;
    successDiv.classList.remove('hidden');
}

// Prevent double submission
let isSubmitting = false;

// Combine address fields
function updateAlamatCuti() {
    const jalan = document.getElementById('alamat_jalan').value;
    const kelurahan = document.getElementById('alamat_kelurahan').value;
    const kabkota = document.getElementById('alamat_kabkota').value;
    
    let alamatLengkap = '';
    if (jalan) alamatLengkap += 'Alamat: ' + jalan;
    if (kelurahan) alamatLengkap += (alamatLengkap ? '\nKelurahan/Desa: ' : 'Kelurahan/Desa: ') + kelurahan;
    if (kabkota) alamatLengkap += (alamatLengkap ? '\nKab/Kota: ' : 'Kab/Kota: ') + kabkota;
    
    document.getElementById('alamat_cuti').value = alamatLengkap;
}

// Parse existing address
function parseEmployeeAddress() {
    const employeeAlamat = '{{ employee.alamat|raw }}';
    if (employeeAlamat && employeeAlamat !== 'null') {
        // Try to parse if it's already in structured format
        const lines = employeeAlamat.split('\n');
        lines.forEach(line => {
            if (line.startsWith('Alamat:')) {
                document.getElementById('alamat_jalan').value = line.replace('Alamat:', '').trim();
            } else if (line.startsWith('Kelurahan/Desa:')) {
                document.getElementById('alamat_kelurahan').value = line.replace('Kelurahan/Desa:', '').trim();
            } else if (line.startsWith('Kab/Kota:')) {
                document.getElementById('alamat_kabkota').value = line.replace('Kab/Kota:', '').trim();
            } else if (!line.includes(':') && line.trim()) {
                // If it's unstructured, put it in alamat field
                document.getElementById('alamat_jalan').value = line.trim();
            }
        });
        updateAlamatCuti();
    }
}

// Update submit button text based on signature method
document.addEventListener('DOMContentLoaded', function() {
    parseEmployeeAddress();
    const form = document.getElementById('cutiForm');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const signatureRadios = document.querySelectorAll('input[name="signature_method"]');
    
    // Prevent double submission
    form.addEventListener('submit', function(e) {
        if (isSubmitting) {
            e.preventDefault();
            return false;
        }
        
        isSubmitting = true;
        submitBtn.disabled = true;
        
        const selectedMethod = document.querySelector('input[name="signature_method"]:checked')?.value;
        if (selectedMethod === 'digital') {
            submitText.textContent = 'Memproses...';
        } else {
            submitText.textContent = 'Membuat...';
        }
    });
    
    signatureRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'digital') {
                submitText.textContent = 'Submit Langsung';
            } else {
                submitText.textContent = 'Buat Pengajuan';
            }
        });
    });
    
    // Calculate days automatically
    const startDate = document.getElementById('tanggal_mulai');
    const endDate = document.getElementById('tanggal_selesai');
    const lamaHari = document.getElementById('lama_hari');
    
    function calculateDays() {
        if (startDate.value && endDate.value) {
            const start = new Date(startDate.value);
            const end = new Date(endDate.value);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            lamaHari.value = diffDays;
        }
    }
    
    startDate.addEventListener('change', calculateDays);
    endDate.addEventListener('change', calculateDays);
    
    // Address field listeners
    document.getElementById('alamat_jalan').addEventListener('input', updateAlamatCuti);
    document.getElementById('alamat_kelurahan').addEventListener('input', updateAlamatCuti);
    document.getElementById('alamat_kabkota').addEventListener('input', updateAlamatCuti);
    
    // Show leave type info and required documents
    const jenisCutiSelect = document.getElementById('jenis_cuti');
    const cutiInfo = document.getElementById('cutiInfo');
    const requiredDocsAlert = document.getElementById('requiredDocsAlert');
    const requiredDocsList = document.getElementById('requiredDocsList');
    const alasanTextarea = document.getElementById('alasan');
    
    const cutiInfoData = {
        'tahunan': 'Minimal 1 tahun kerja. Hak 12 hari/tahun. Minimal 1 hari. Sisa maksimal 6 hari dapat dibawa ke tahun berikutnya.',
        'besar': 'Minimal 5 tahun kerja. Maksimal 3 bulan. Tidak dapat bersamaan dengan cuti tahunan.',
        'sakit': 'Maksimal 1 tahun. Perlu surat keterangan dokter.',
        'melahirkan': 'Untuk kelahiran anak 1-3. Lamanya 3 bulan.',
        'alasan_penting': 'Maksimal 1 bulan. Untuk keadaan darurat keluarga.',
        'diluar_tanggungan': 'Minimal 5 tahun kerja. Maksimal 3 tahun. Tidak mendapat gaji.'
    };
    
    jenisCutiSelect.addEventListener('change', function() {
        const selectedType = this.value;
        
        if (selectedType && cutiInfoData[selectedType]) {
            cutiInfo.textContent = cutiInfoData[selectedType];
            cutiInfo.classList.remove('hidden');
        } else {
            cutiInfo.classList.add('hidden');
        }
        
        checkRequiredDocuments();
    });
    
    alasanTextarea.addEventListener('input', checkRequiredDocuments);
    
    function checkRequiredDocuments() {
        const jenisCuti = jenisCutiSelect.value;
        const alasan = alasanTextarea.value.toLowerCase();
        let requiredDocs = [];
        
        switch (jenisCuti) {
            case 'sakit':
                if (alasan.includes('rawat inap')) {
                    requiredDocs.push('Surat keterangan rawat inap dari Unit Pelayanan Kesehatan');
                } else {
                    requiredDocs.push('Surat keterangan dokter');
                }
                break;
                
            case 'melahirkan':
                requiredDocs.push('Surat keterangan dokter/bidan');
                break;
                
            case 'alasan_penting':
                if (alasan.includes('sakit keras')) {
                    requiredDocs.push('Surat keterangan rawat inap dari Unit Pelayanan Kesehatan');
                } else if (alasan.includes('meninggal')) {
                    requiredDocs.push('Surat keterangan kematian dari Desa/RT');
                } else if (alasan.includes('perkawinan') || alasan.includes('nikah')) {
                    requiredDocs.push('Keterangan/undangan pernikahan');
                } else if (alasan.includes('melahirkan') || alasan.includes('caesar')) {
                    requiredDocs.push('Surat keterangan rawat inap dari Unit Pelayanan Kesehatan');
                } else if (alasan.includes('kebakaran') || alasan.includes('bencana')) {
                    requiredDocs.push('Surat keterangan dari Desa/RT');
                }
                break;
                
            case 'diluar_tanggungan':
                if (alasan.includes('tugas negara') || alasan.includes('tugas belajar')) {
                    requiredDocs.push('Surat penugasan atau surat perintah tugas negara/tugas belajar');
                } else if (alasan.includes('bekerja')) {
                    requiredDocs.push('Surat keputusan atau surat penugasan/pengangkatan dalam jabatan');
                } else if (alasan.includes('keturunan')) {
                    requiredDocs.push('Surat keterangan dokter spesialis');
                } else if (alasan.includes('berkebutuhan khusus') || alasan.includes('perawatan khusus')) {
                    requiredDocs.push('Surat keterangan dokter spesialis');
                } else if (alasan.includes('orang tua') || alasan.includes('mertua')) {
                    requiredDocs.push('Surat keterangan dokter');
                }
                break;
        }
        
        if (requiredDocs.length > 0) {
            requiredDocsList.innerHTML = '<ul class="list-disc list-inside">' + 
                requiredDocs.map(doc => '<li>' + doc + '</li>').join('') + '</ul>';
            requiredDocsAlert.classList.remove('hidden');
        } else {
            requiredDocsAlert.classList.add('hidden');
        }
    }
});
</script>
=======
>>>>>>> parent of 53b33dd (Basic Function)
{% endblock %}